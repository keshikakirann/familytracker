<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Family Location Tracker</title>

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
/>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
        color: #4a5568;
        font-size: 2.5em;
        margin-bottom: 10px;
    }

    .header p {
        color: #718096;
        font-size: 1.1em;
    }

    .main-content {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
    }

    .map-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .family-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        height: 500px;
    }

    #map {
        height: 500px;
        border-radius: 15px;
        overflow: hidden;
        border: 2px solid #e2e8f0;
    }

    .family-member {
        display: flex;
        align-items: center;
        padding: 15px;
        border-radius: 15px;
        margin-bottom: 15px;
        background: #f7fafc;
        border: 2px solid #e2e8f0;
        transition: all 0.3s ease;
        cursor: pointer;
        user-select: none;
    }

    .family-member:hover {
        background: #edf2f7;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .family-member.active {
        background: #e6fffa;
        border-color: #38b2ac;
    }

    .avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(45deg, #4facfe, #00f2fe);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        margin-right: 15px;
        position: relative;
        flex-shrink: 0;
        font-size: 1.3rem;
    }

    .status-indicator {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 15px;
        height: 15px;
        border-radius: 50%;
        border: 2px solid white;
    }

    .online { background: #48bb78; }
    .away { background: #ed8936; }
    .offline { background: #a0aec0; }

    .member-info h3 {
        margin-bottom: 5px;
        color: #2d3748;
    }

    .member-info p {
        color: #718096;
        font-size: 0.9em;
    }

    .member-info small {
        color: #a0aec0;
        font-size: 0.8em;
    }

    .controls {
        display: flex;
        gap: 10px;
        margin-top: auto;
        flex-wrap: wrap;
        justify-content: center;
    }

    .btn {
        padding: 12px 20px;
        border: none;
        border-radius: 10px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
        min-width: 140px;
        justify-content: center;
        user-select: none;
    }

    .btn-primary {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
        background: #edf2f7;
        color: #4a5568;
    }

    .btn-secondary:hover {
        background: #e2e8f0;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .alert {
        background: #fed7e2;
        border: 1px solid #fbb6ce;
        color: #975a5a;
        padding: 15px;
        border-radius: 10px;
        margin-top: 20px;
        display: none;
        text-align: center;
        font-weight: 600;
    }

    .alert.show {
        display: block;
    }

    .alert.success {
        background: #c6f6d5;
        border-color: #9ae6b4;
        color: #276749;
    }

    .section-title {
        font-size: 1.4em;
        margin-bottom: 15px;
        color: #2d3748;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .location-details {
        background: #f7fafc;
        border-radius: 10px;
        padding: 15px;
        margin-top: 15px;
        border: 2px solid #e2e8f0;
        flex-grow: 1;
        overflow-y: auto;
    }

    .distance-info {
        background: #e6fffa;
        border-radius: 8px;
        padding: 10px;
        margin-top: 10px;
        border-left: 4px solid #38b2ac;
    }

    .gps-info {
        background: #fff5f5;
        border-radius: 8px;
        padding: 10px;
        margin-top: 10px;
        border-left: 4px solid #f56565;
        font-size: 0.9em;
    }

    .accuracy-indicator {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.8em;
        margin-left: 5px;
    }

    .accuracy-good { background: #c6f6d5; color: #276749; }
    .accuracy-fair { background: #faf089; color: #744210; }
    .accuracy-poor { background: #fed7e2; color: #975a5a; }

    .geo-status {
        background: #e6fffa;
        border: 1px solid #9ae6b4;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 15px;
        font-size: 0.9em;
        color: #276749;
    }

    .geo-status.requesting {
        background: #faf089;
        border-color: #ecc94b;
        color: #744210;
    }

    .geo-status.denied {
        background: #fed7e2;
        border-color: #fbb6ce;
        color: #975a5a;
    }

    .geo-status.error {
        background: #fff5f5;
        border-color: #fbb6ce;
        color: #975a5a;
    }

    .join-section {
        background: #fff5f5;
        border: 2px solid #fbb6ce;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        display: none;
    }

    .join-section.show {
        display: block;
    }

    .join-section h3 {
        color: #975a5a;
        margin-bottom: 10px;
        text-align: center;
    }

    .join-input {
        width: 100%;
        padding: 10px;
        border: 1px solid #e2e8f0;
        border-radius: 5px;
        margin-bottom: 10px;
        font-size: 1rem;
    }

    @media (max-width: 768px) {
        .main-content {
            grid-template-columns: 1fr;
        }
        
        .header h1 {
            font-size: 2em;
        }

        #map {
            height: 400px;
        }
    }
</style>

</head>
<body>

<div class="container">
  <header class="header">
    <h1>Family Location Tracker</h1>
    <p>Keep your loved ones close, even when far away.</p>
  </header>

  <section id="joinSection" class="join-section">
    <h3>You were invited! Enter your name to join the family group:</h3>
    <input
      type="text"
      id="joinNameInput"
      class="join-input"
      placeholder="Your name here..."
      autocomplete="off"
    />
    <button class="btn btn-primary" onclick="joinFamily()">Join Family</button>
  </section>

  <div class="main-content">
    <section class="map-section">
      <div id="map"></div>
    </section>

    <section class="family-section" aria-label="Family members and details">
      <div id="familyList" style="overflow-y:auto; flex-grow:1;"></div>

      <div class="location-details" id="locationDetails" aria-live="polite">
        <h3 id="selectedMemberName">Select a family member</h3>
        <p id="selectedMemberLocation"></p>
        <p id="selectedMemberTime"></p>
        <div class="distance-info" id="distanceInfo"></div>
        <div class="gps-info" id="gpsInfo"></div>
      </div>

      <div class="controls">
        <button id="shareBtn" class="btn btn-primary" onclick="shareMyLocation()">Share My Location</button>
        <button id="toggleBtn" class="btn btn-secondary" onclick="toggleLocationSharing()">Auto-Share OFF</button>
      </div>

      <div id="alertBox" class="alert" role="alert" aria-live="assertive"></div>
    </section>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

<script>
  // -- Firebase config: REPLACE these with your actual values --
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Globals
  let currentFamilyId = null;
  let myUserId = 'user_' + Math.random().toString(36).slice(2, 11);
  let familyMembers = [];
  let selectedMemberId = null;
  let map = null;
  let markers = {};
  let myLocation = null;
  let locationSharingEnabled = false;
  let watchId = null;
  let unsubscribeFamilySync = null;

  // Utility: format timestamp to readable string
  function formatTime(date) {
    return date.toLocaleString();
  }

  // Show alert message with type: 'success', 'error', or ''
  function showAlert(message, type = '') {
    const alertBox = document.getElementById('alertBox');
    alertBox.textContent = message;
    alertBox.className = 'alert show';
    if(type) alertBox.classList.add(type);
    setTimeout(() => {
      alertBox.className = 'alert';
    }, 3500);
  }

  // Initialize map centered on some default coords
  function initMap() {
    const defaultLatLng = [51.1657, 10.4515]; // Germany center
    map = L.map('map').setView(defaultLatLng, 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors',
    }).addTo(map);
  }

  // Render family members list in sidebar
  function renderFamilyMembers() {
    const list = document.getElementById('familyList');
    list.innerHTML = '';

    familyMembers.forEach(member => {
      const memberEl = document.createElement('div');
      memberEl.className = 'family-member';
      if(member.id === selectedMemberId) {
        memberEl.classList.add('active');
      }

      // avatar with status dot
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = member.avatar || member.name[0].toUpperCase();
      const statusDot = document.createElement('div');
      statusDot.className = 'status-indicator ' + (member.status || 'offline');
      avatar.appendChild(statusDot);

      // info
      const info = document.createElement('div');
      info.className = 'member-info';
      const name = document.createElement('h3');
      name.textContent = member.name + (member.isMe ? ' (You)' : '');
      const lastSeen = document.createElement('p');
      lastSeen.textContent = 'Last seen: ' + (member.lastSeen || 'Never');
      info.appendChild(name);
      info.appendChild(lastSeen);

      memberEl.appendChild(avatar);
      memberEl.appendChild(info);

      memberEl.onclick = () => selectMember(member.id);

      list.appendChild(memberEl);
    });
  }

  // Select member to show location details
  function selectMember(id) {
    selectedMemberId = id;
    renderFamilyMembers();
    updateLocationDetails();
  }

  // Update location details panel for selected member
  function updateLocationDetails() {
    const nameEl = document.getElementById('selectedMemberName');
    const locEl = document.getElementById('selectedMemberLocation');
    const timeEl = document.getElementById('selectedMemberTime');
    const distEl = document.getElementById('distanceInfo');
    const gpsEl = document.getElementById('gpsInfo');

    if(!selectedMemberId) {
      nameEl.textContent = 'Select a family member';
      locEl.textContent = '';
      timeEl.textContent = '';
      distEl.textContent = '';
      gpsEl.textContent = '';
      return;
    }

    const member = familyMembers.find(m => m.id === selectedMemberId);
    if(!member) return;

    nameEl.textContent = member.name + (member.isMe ? ' (You)' : '');

    if(member.location) {
      locEl.textContent = `Location: ${member.location.lat.toFixed(5)}, ${member.location.lng.toFixed(5)}`;
      timeEl.textContent = `Last updated: ${member.lastSeen || 'Unknown'}`;

      if(myLocation && member.id !== myUserId) {
        const dist = getDistanceMeters(myLocation.lat, myLocation.lng, member.location.lat, member.location.lng);
        distEl.textContent = `Distance from you: ${dist.toFixed(0)} meters`;
      } else {
        distEl.textContent = '';
      }

      gpsEl.textContent = member.accuracy ? `GPS accuracy: ±${member.accuracy} meters` : '';
    } else {
      locEl.textContent = 'No location data';
      timeEl.textContent = '';
      distEl.textContent = '';
      gpsEl.textContent = '';
    }
  }

  // Haversine formula for distance in meters
  function getDistanceMeters(lat1, lon1, lat2, lon2) {
    function toRad(x) { return x * Math.PI / 180; }
    const R = 6371000;
    const dLat = toRad(lat2-lat1);
    const dLon = toRad(lon2-lon1);
    const a = Math.sin(dLat/2)*Math.sin(dLat/2) +
              Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
              Math.sin(dLon/2)*Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  // Update markers on map for all family members
  function updateMapMarkers() {
    if(!map) return;

    // Remove markers no longer in family
    Object.keys(markers).forEach(id => {
      if(!familyMembers.find(m => m.id === id)) {
        map.removeLayer(markers[id]);
        delete markers[id];
      }
    });

    familyMembers.forEach(member => {
      if(member.location) {
        if(markers[member.id]) {
          markers[member.id].setLatLng(member.location);
        } else {
          const marker = L.marker(member.location).addTo(map);
          marker.bindPopup(`<b>${member.name}</b><br>Last updated: ${member.lastSeen || 'Unknown'}`);
          markers[member.id] = marker;
        }
      }
    });
  }

  // Share my current location once (via browser geolocation)
  function shareMyLocation() {
    if(!navigator.geolocation) {
      showAlert("Geolocation is not supported by your browser.", "error");
      return;
    }

    navigator.geolocation.getCurrentPosition(async pos => {
      const { latitude, longitude, accuracy } = pos.coords;
      myLocation = { lat: latitude, lng: longitude };
      const timestamp = new Date();

      await db.collection('families').doc(currentFamilyId).collection('members').doc(myUserId).set({
        name: myName,
        location: new firebase.firestore.GeoPoint(latitude, longitude),
        accuracy,
        lastSeen: timestamp,
        status: 'online',
        avatar: myAvatar
      }, { merge: true });

      showAlert("Location shared successfully!", "success");
    }, err => {
      showAlert("Failed to get location: " + err.message, "error");
    });
  }

  // Start or stop automatic location sharing (watchPosition)
  function toggleLocationSharing() {
    const toggleBtn = document.getElementById('toggleBtn');
    if(locationSharingEnabled) {
      // stop watching
      if(watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      locationSharingEnabled = false;
      toggleBtn.textContent = 'Auto-Share OFF';
      toggleBtn.classList.remove('btn-primary');
      toggleBtn.classList.add('btn-secondary');
      showAlert("Auto location sharing stopped.");
    } else {
      if(!navigator.geolocation) {
        showAlert("Geolocation is not supported by your browser.", "error");
        return;
      }
      watchId = navigator.geolocation.watchPosition(async pos => {
        const { latitude, longitude, accuracy } = pos.coords;
        myLocation = { lat: latitude, lng: longitude };
        const timestamp = new Date();

        await db.collection('families').doc(currentFamilyId).collection('members').doc(myUserId).set({
          name: myName,
          location: new firebase.firestore.GeoPoint(latitude, longitude),
          accuracy,
          lastSeen: timestamp,
          status: 'online',
          avatar: myAvatar
        }, { merge: true });

        updateLocationDetails();
      }, err => {
        showAlert("Error watching position: " + err.message, "error");
      }, {
        enableHighAccuracy: true,
        maximumAge: 5000,
        timeout: 10000
      });

      locationSharingEnabled = true;
      toggleBtn.textContent = 'Auto-Share ON';
      toggleBtn.classList.remove('btn-secondary');
      toggleBtn.classList.add('btn-primary');
      showAlert("Auto location sharing started.", "success");
    }
  }

  // Listen for family members in Firestore and update UI/map realtime
  function subscribeToFamilyUpdates() {
    if(unsubscribeFamilySync) unsubscribeFamilySync();

    unsubscribeFamilySync = db.collection('families').doc(currentFamilyId).collection('members')
      .onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
          const data = change.doc.data();
          const id = change.doc.id;

          // Update or add member
          const index = familyMembers.findIndex(m => m.id === id);
          const memberData = {
            id,
            name: data.name || 'Unnamed',
            location: data.location ? { lat: data.location.latitude, lng: data.location.longitude } : null,
            lastSeen: data.lastSeen ? data.lastSeen.toDate().toLocaleString() : null,
            accuracy: data.accuracy,
            status: data.status || 'offline',
            avatar: data.avatar || null,
            isMe: (id === myUserId)
          };

          if(index === -1) familyMembers.push(memberData);
          else familyMembers[index] = memberData;
        });

        renderFamilyMembers();
        updateMapMarkers();
        updateLocationDetails();
      });
  }

  // Join a family group (here just a random ID or input name used)
  let myName = '';
  let myAvatar = '';

  function joinFamily() {
    const input = document.getElementById('joinNameInput');
    if(!input.value.trim()) {
      showAlert('Please enter your name before joining.', 'error');
      return;
    }

    myName = input.value.trim();
    myAvatar = myName[0].toUpperCase();

    // For demo, use a fixed familyId — in practice, get this from invite link
    currentFamilyId = 'demo-family-001';

    // Hide join section and show main UI
    document.getElementById('joinSection').classList.remove('show');
    document.getElementById('joinSection').style.display = 'none';

    subscribeToFamilyUpdates();
    showAlert(`Welcome, ${myName}! You joined the family group.`, 'success');

    // Add me to family members with offline status initially
    db.collection('families').doc(currentFamilyId).collection('members').doc(myUserId).set({
      name: myName,
      status: 'offline',
      avatar: myAvatar,
      lastSeen: null,
      location: null
    });

    // Select me by default
    selectedMemberId = myUserId;
    renderFamilyMembers();
  }

  // On page load
  window.onload = () => {
    initMap();
    document.getElementById('joinSection').classList.add('show');
  };
</script>
</body>
</html>
